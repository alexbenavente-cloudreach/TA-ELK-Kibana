---
- hosts: Kibana_server
  become: true
  tasks:  

#adding the Elasticsearch package as test to make sure Logstach will run
  - name: Adding Elasticsearch PGP Key
    shell: |
      wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
    args:
        warn: no

#Adding as well elastic serach repository for testing purposes
  - name: Adding Elasticsearch repository
    copy:
      dest: /etc/apt/sources.list.d/elastic-7.x.list
      content: |
        deb https://artifacts.elastic.co/packages/7.x/apt stable main

  - name: Transport Http for Kibana
    apt:
      name: apt-transport-https
      state: present

  - name: Install Kibana with apt
    apt:
        name: kibana
        update_cache: yes
 
# Configurations

  - name: Updating the config file to allow outside access
    lineinfile:
      destfile: /etc/kibana/kibana.yml
      regexp: 'server.host:'
      line: 'server.host: 0.0.0.0'

  - name: Defining server port
    lineinfile:
      destfile: /etc/kibana/kibana.yml
      regexp: 'server.port:'
      line: 'server.port: 5601'
    
  - name: Defining Elasticsearch URL
    lineinfile:
      destfile: /etc/kibana/kibana.yml
      regexp: 'elasticsearch.url:'
      line: 'elasticsearch.url: "http://localhost:9200"'
# Install Kibana 

  - name: Install Kibana with apt
    apt:
     name: kibana
     update_cache: yes
 
# Configurations

  - name: Updating the config file to allow outside access
    lineinfile:
     destfile: /etc/kibana/kibana.yml
     regexp: 'server.host:'
     line: 'server.host: 0.0.0.0'

  - name: Defining server port
    lineinfile:
      destfile: /etc/kibana/kibana.yml
      regexp: 'server.port:'
      line: 'server.port: 5601'
    
  - name: Defining Elasticsearch URL
    lineinfile:
      destfile: /etc/kibana/kibana.yml
      regexp: 'elasticsearch.url:'
      line: 'elasticsearch.url: "http://localhost:9200"'
   
# Starting Kibana

  - name: Starting Kibana
    service:
      name: kibana
      state: started

